name: Docker CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

permissions:
  contents: read

jobs:
  docker-build:
    name: Docker Build & Validate
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create .env.docker for CI
      run: |
        cat > .env.docker << EOF
        APP_ENV=prod
        APP_SECRET=test-secret-key-for-ci-docker
        DATABASE_URL=mysql://root:root@mysql:3306/gorun?serverVersion=9.1
        NGINX_PORT=8080
        MYSQL_PORT=3307
        USER_ID=1000
        GROUP_ID=1000
        EOF

    - name: Build Docker images
      run: docker compose build --no-cache

    - name: Start Docker containers
      run: docker compose up -d

    - name: Wait for MySQL
      run: |
        echo "Waiting for MySQL..."
        timeout 90 bash -c 'until docker compose exec -T mysql mysqladmin ping -h localhost --silent; do sleep 2; done'
        echo "✅ MySQL ready"

    - name: Wait for PHP-FPM
      run: |
        echo "Waiting for PHP-FPM..."
        timeout 30 bash -c 'until docker compose exec -T php php -v > /dev/null 2>&1; do sleep 2; done'
        echo "✅ PHP-FPM ready"

    - name: Verify containers are running
      run: docker compose ps

    - name: Check PHP version
      run: docker compose exec -T php php -v

    - name: Verify database connection
      run: |
        docker compose exec -T php php bin/console dbal:run-sql "SELECT 1" || exit 1
        echo "✅ Database connection successful"

    - name: Create database
      run: docker compose exec -T php php bin/console doctrine:database:create --if-not-exists

    - name: Run migrations
      run: docker compose exec -T php php bin/console doctrine:migrations:migrate --no-interaction

    - name: Warmup cache
      run: docker compose exec -T php php bin/console cache:warmup

    - name: Check logs before HTTP test
      run: |
        echo "=== PHP-FPM logs ==="
        docker compose logs php | tail -30
        echo ""
        echo "=== Nginx logs ==="
        docker compose logs nginx | tail -30

    - name: Test HTTP response
      run: |
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)
        echo "HTTP Response Code: $HTTP_CODE"
        if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 302 ]; then
          echo "✅ Application responds correctly"
        else
          echo "❌ Application returned unexpected code: $HTTP_CODE"
          echo ""
          echo "=== Full response for debugging ==="
          curl -v http://localhost:8080
          exit 1
        fi

    - name: Show Docker logs on failure
      if: failure()
      run: docker compose logs

    - name: Stop Docker containers
      if: always()
      run: docker compose down -v