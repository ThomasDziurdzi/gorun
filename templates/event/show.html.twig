{% extends 'base.html.twig' %}
{% block title %}D√©tail √©v√®nement ¬∑ GoRun{% endblock %}
{% block body %}
{% set confirmedCount = e.registrations|filter(r => r.status.value == 'CONFIRMED')|length %}
{% set spotsLeft = e.spotsLeft %}
{% set effectiveStatus = e.effectiveStatus %}
{% set canRegister = e.canRegister %}
{% set shouldGray = effectiveStatus.value == 'COMPLETED' %}

<section class="relative rounded-2xl overflow-hidden {{ shouldGray ? 'opacity-80' : '' }}">
  <img src="{{ e.coverImage ? vich_uploader_asset(e, 'imageFile') : asset('uploads/events/14865.jpg') }}" 
       alt="{{ e.title }}" 
       class="h-[50vh] w-full object-cover {{ shouldGray ? 'grayscale' : '' }}" />
  <div class="absolute inset-0 bg-black/40"></div>
  
  {# Badge de statut sur l'image #}
  {% if effectiveStatus.value == 'COMPLETED' %}
    <div class="absolute top-6 right-6 bg-gray-900 bg-opacity-90 text-white px-4 py-2 rounded-full text-sm font-semibold flex items-center gap-2">
      √âv√©nement termin√©
    </div>
  {% elseif effectiveStatus.value == 'CANCELLED' %}
    <div class="absolute top-6 right-6 bg-red-600 bg-opacity-90 text-white px-4 py-2 rounded-full text-sm font-semibold flex items-center gap-2">
      √âv√©nement annul√©
    </div>
  {% elseif effectiveStatus.value == 'DRAFT' %}
    <div class="absolute top-6 right-6 bg-yellow-500 bg-opacity-90 text-white px-4 py-2 rounded-full text-sm font-semibold flex items-center gap-2">
      Brouillon
    </div>
  {% endif %}
  
  <div class="absolute inset-0 flex items-end">
    <div class="max-w-6xl mx-auto px-4 md:px-6 pb-6">
      <h1 class="text-3xl md:text-4xl font-extrabold text-white drop-shadow {{ shouldGray ? 'opacity-90' : '' }}">
        {{ e.title }}
      </h1>
      <p class="text-white/90 mt-2">
        {{ e.eventDate|date('l d F Y √† H:i')|capitalize }} ‚Ä¢
        {{ e.location.city }} ‚Ä¢
        {{ e.distance }} km
        {% if e.pace %} ‚Ä¢ Allure {{ e.pace }}{% endif %}
      </p>
    </div>
  </div>
</section>

<main class="py-8 grid lg:grid-cols-3 gap-8">
  <article class="lg:col-span-2 space-y-6">
    <div class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-xl font-bold mb-4">√Ä propos</h2>
      <p class="text-gray-700 mb-6">{{ e.description ?: 'Aucune description disponible.' }}</p>

      <div class="grid sm:grid-cols-2 gap-4">
        <div class="p-4 rounded-2xl bg-gray-50">
          <h3 class="font-semibold mb-1">Date et heure</h3>
          <p class="text-gray-700">{{ e.eventDate|date('d/m/Y √† H:i') }}</p>
        </div>
        <div class="p-4 rounded-2xl bg-gray-50">
          <h3 class="font-semibold mb-1">Dur√©e estim√©e</h3>
          <p class="text-gray-700">
            {% if e.estimateDuration %}
              {{ (e.estimateDuration / 60)|round(0, 'floor') }}h{{ e.estimateDuration % 60 }}min
            {% else %}
              Non pr√©cis√©e
            {% endif %}
          </p>
        </div>
        <div class="p-4 rounded-2xl bg-gray-50">
          <h3 class="font-semibold mb-1">Distance</h3>
          <p class="text-gray-700">{{ e.distance }} km</p>
        </div>
        <div class="p-4 rounded-2xl bg-gray-50">
          <h3 class="font-semibold mb-1">Allure pr√©vue</h3>
          <p class="text-gray-700">{{ e.pace ?: 'Non pr√©cis√©e' }}</p>
        </div>
        <div class="p-4 rounded-2xl bg-gray-50">
          <h3 class="font-semibold mb-1">Niveau requis</h3>
          <p class="text-gray-700">
            {{ e.requiredLevel.label }}
          </p>
        </div>
        <div class="p-4 rounded-2xl bg-gray-50">
          <h3 class="font-semibold mb-1">Participants</h3>
          <p class="text-gray-700">
            {% if e.maxParticipants is null %}
              {{ confirmedCount }}
            {% else %}
              {{ confirmedCount }} / {{ e.maxParticipants }}
            {% endif %}
          </p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-xl font-bold mb-4">Lieu de rendez-vous</h2>

      <div class="mb-4">
        <h3 class="font-semibold mb-2">{{ e.location.locationName }}</h3>
        <p class="text-gray-700">
          {{ e.location.address }}<br>
          {{ e.location.postalCode }} {{ e.location.city }}
          {% if e.location.country %}, {{ e.location.country }}{% endif %}
        </p>
        {% if e.location.meetingPoint %}
          <p class="text-sm text-gray-600 mt-2">
            <strong>Point de RDV pr√©cis :</strong> {{ e.location.meetingPoint }}
          </p>
        {% endif %}
        {% if e.location.description %}
          <p class="text-sm text-gray-600 mt-2">{{ e.location.description }}</p>
        {% endif %}
      </div>

      <div class="rounded-2xl overflow-hidden border">
        <iframe
          title="Carte du lieu"
          src="https://www.openstreetmap.org/export/embed.html?bbox={{ e.location.longitude - 0.01 }}%2C{{ e.location.latitude - 0.01 }}%2C{{ e.location.longitude + 0.01 }}%2C{{ e.location.latitude + 0.01 }}&layer=mapnik&marker={{ e.location.latitude }}%2C{{ e.location.longitude }}"
          class="w-full h-72"
        ></iframe>
      </div>
      <p class="text-xs text-gray-500 mt-2">
        Coordonn√©es : {{ e.location.latitude }}, {{ e.location.longitude }}
      </p>
    </div>

    <div class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
       Commentaires
        <span class="text-lg text-gray-500">({{ comments|length }})</span>
      </h2>
      <div class="space-y-8">
        {{ include('comment/_form.html.twig', {event: e, commentForm: commentForm}) }}
        <div>
          <h3 class="text-xl font-semibold mb-4">Tous les commentaires</h3>
          {{ include('comment/_list.html.twig', {comments: comments}) }}
        </div>
      </div>
    </div>
  </article>

  <aside class="lg:col-span-1 space-y-6">
    {# ========== BLOC INSCRIPTION ========== #}
    <div class="bg-white rounded-2xl shadow p-6">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Inscription</h3>
        
        {% if effectiveStatus.value == 'PUBLISHED' %}
          {% if e.maxParticipants is null %}
            <span class="text-sm font-medium text-blue-600">Illimit√©</span>
          {% elseif spotsLeft > 0 %}
            <span class="text-sm font-medium {{ spotsLeft <= 5 ? 'text-amber-600' : 'text-green-600' }}">
              {{ spotsLeft }} place{{ spotsLeft > 1 ? 's' : '' }} restante{{ spotsLeft > 1 ? 's' : '' }}
            </span>
          {% else %}
            <span class="text-sm font-medium text-red-600">Complet</span>
          {% endif %}
        {% elseif effectiveStatus.value == 'COMPLETED' %}
          <span class="text-sm font-medium text-gray-600">{{ confirmedCount }} participant{{ confirmedCount > 1 ? 's' : '' }}</span>
        {% endif %}
      </div>

      {# ===== CAS 1 : √âv√©nement TERMIN√â ===== #}
      {% if effectiveStatus.value == 'COMPLETED' %}
        <div class="bg-gray-100 border border-gray-300 rounded-2xl p-4">
          <p class="text-gray-700 text-center font-medium">Cet √©v√©nement est termin√©</p>
        </div>

      {# ===== CAS 2 : √âv√©nement ANNUL√â ===== #}
      {% elseif effectiveStatus.value == 'CANCELLED' %}
        <div class="bg-red-50 border border-red-200 rounded-2xl p-4">
          <p class="text-red-700 text-center font-medium">Cet √©v√©nement a √©t√© annul√©</p>
        </div>

      {# ===== CAS 3 : √âv√©nement BROUILLON ===== #}
      {% elseif effectiveStatus.value == 'DRAFT' %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-2xl p-4">
          <p class="text-yellow-700 text-center font-medium">Cet √©v√©nement n'est pas encore publi√©</p>
        </div>

      {# ===== CAS 4 : √âv√©nement PUBLI√â - Logique d'inscription ===== #}
      {% else %}
        {% if app.user %}
          {# V√©rifier si l'utilisateur est d√©j√† inscrit #}
          {% set userRegistration = null %}
          {% for registration in e.registrations %}
            {% if registration.user.id == app.user.id and registration.status.value == 'CONFIRMED' %}
              {% set userRegistration = registration %}
            {% endif %}
          {% endfor %}

          {% if userRegistration %}
            {# Utilisateur d√©j√† inscrit #}
            <div class="bg-green-50 border border-green-200 rounded-2xl p-4 mb-3">
              <p class="text-green-800 font-medium">‚úÖ Vous √™tes inscrit √† cet √©v√©nement</p>
              <p class="text-sm text-green-700 mt-1">
                Inscrit le {{ userRegistration.registrationDate|date('d/m/Y √† H:i') }}
              </p>
            </div>

            <form method="post" action="{{ path('event_unregister', {id: e.id}) }}"
                  onsubmit="return confirm('√ätes-vous s√ªr de vouloir vous d√©sinscrire ?');">
              <input type="hidden" name="_token" value="{{ csrf_token('unregister' ~ e.id) }}">
              <button type="submit" class="block w-full text-center bg-red-600 text-white py-3 rounded-2xl font-semibold hover:bg-red-700 transition">
                Me d√©sinscrire
              </button>
            </form>
          {% else %}
            {# Utilisateur pas encore inscrit #}
            {% if canRegister %}
              {# Peut s'inscrire #}
              <form method="post" action="{{ path('event_register', {id: e.id}) }}">
                <input type="hidden" name="_token" value="{{ csrf_token('register' ~ e.id) }}">
                <button type="submit" class="block w-full text-center bg-green-600 text-white py-3 rounded-2xl font-semibold hover:bg-green-700 transition">
                  Je m'inscris
                </button>
              </form>
            {% else %}
              {# √âv√©nement complet #}
              <button disabled class="block w-full text-center bg-gray-400 text-white py-3 rounded-2xl font-semibold cursor-not-allowed">
                ‚ö†Ô∏è Complet
              </button>
            {% endif %}
          {% endif %}
        {% else %}
          {# Utilisateur non connect√© #}
          <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4 mb-3">
            <p class="text-blue-800 text-sm">
              Vous devez √™tre connect√© pour vous inscrire √† cet √©v√©nement.
            </p>
          </div>
          <a href="{{ path('app_login') }}" class="block w-full text-center bg-green-600 text-white py-3 rounded-2xl font-semibold hover:bg-green-700 transition">
            Se connecter
          </a>
        {% endif %}
      {% endif %}
    </div>

    {# ========== BLOC ADMINISTRATION ========== #}
    {% if is_granted('ROLE_ADMIN') %}
      <div class="bg-amber-50 border border-amber-200 rounded-2xl p-6">
        <h3 class="font-semibold mb-3 text-amber-800">Administration</h3>
        <div class="space-y-3">
          
          {# Bouton Modifier (sauf si termin√© ou annul√©) #}
          {% if effectiveStatus.value != 'COMPLETED' and effectiveStatus.value != 'CANCELLED' %}
            <a href="{{ path('event_edit', {id: e.id}) }}"
               class="block w-full text-center bg-blue-600 text-white py-3 rounded-2xl font-semibold hover:bg-blue-700 transition flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
              Modifier
            </a>
          {% endif %}

          {# Publier (si brouillon) #}
         {% if e.status.value == 'DRAFT' and e.effectiveStatus.value == 'DRAFT' %}
          <div class="mb-3 p-3 bg-yellow-100 border border-yellow-300 rounded-xl text-sm text-yellow-800">
            ‚ö†Ô∏è La date de cet √©v√©nement est pass√©e. Vous devez modifier la date avant de pouvoir le publier.
          </div>
        {% endif %}
        
        <div class="space-y-3">
          {# Bouton Publier (d√©sactiv√© si date pass√©e) #}
          {% if e.status.value == 'DRAFT' %}
            {% if effectiveStatus.value != 'DRAFT' %}
              <button disabled 
                      class="block w-full text-center bg-gray-400 text-white py-3 rounded-2xl font-semibold cursor-not-allowed">
                üöÄ Publier (impossible : date pass√©e)
              </button>
            {% else %}
              <form method="post" action="{{ path('event_publish', {id: e.id}) }}">
                <input type="hidden" name="_token" value="{{ csrf_token('publish' ~ e.id) }}">
                <button type="submit" 
                        class="block w-full text-center bg-green-600 text-white py-3 rounded-2xl font-semibold hover:bg-green-700 transition">
                  üöÄ Publier
                </button>
              </form>
            {% endif %}
          {% endif %}

          {# D√©publier (si publi√© et pas pass√©) #}
          {% if e.status.value == 'PUBLISHED' and effectiveStatus.value == 'PUBLISHED' %}
            <form method="post" action="{{ path('event_unpublish', {id: e.id}) }}">
              <input type="hidden" name="_token" value="{{ csrf_token('unpublish' ~ e.id) }}">
              <button type="submit" 
                      class="block w-full text-center bg-gray-600 text-white py-3 rounded-2xl font-semibold hover:bg-gray-700 transition flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                </svg>
                D√©publier
              </button>
            </form>
          {% endif %}

          {# Annuler (si publi√© ou brouillon et pas termin√©) #}
          {% if (e.status.value == 'PUBLISHED' or e.status.value == 'DRAFT') and effectiveStatus.value != 'COMPLETED' %}
            <form method="post" 
                  action="{{ path('event_cancel', {id: e.id}) }}"
                  onsubmit="return confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir annuler cet √©v√©nement ? Cette action est d√©finitive.')">
              <input type="hidden" name="_token" value="{{ csrf_token('cancel' ~ e.id) }}">
              <button type="submit" 
                      class="block w-full text-center bg-orange-600 text-white py-3 rounded-2xl font-semibold hover:bg-orange-700 transition flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                Annuler l'√©v√©nement
              </button>
            </form>
          {% endif %}

          {# Supprimer #}
          <form method="post" action="{{ path('event_delete', {id: e.id}) }}"
                onsubmit="return confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer d√©finitivement cet √©v√©nement ?');">
            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ e.id) }}">
            <button type="submit"
                    class="block w-full text-center bg-red-600 text-white py-3 rounded-2xl font-semibold hover:bg-red-700 transition flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
              Supprimer
            </button>
          </form>
        </div>
      </div>
    {% endif %}

    {# ========== BLOC ORGANISATEUR ========== #}
    <div class="bg-white rounded-2xl shadow p-6">
      <h3 class="font-semibold mb-3">Organisateur</h3>
      <div class="flex items-start gap-3">
        <div class="h-12 w-12 rounded-full shrink-0 overflow-hidden">
          {% if e.organizer.profilePicture %}
            <img src="{{ vich_uploader_asset(e.organizer, 'profilePictureFile') }}" 
                 alt="{{ e.organizer.firstname }} {{ e.organizer.lastname }}" 
                 class="w-full h-full object-cover">
          {% else %}
            <div class="w-full h-full bg-green-100 flex items-center justify-center font-bold text-green-700">
              {{ e.organizer.firstname|first }}{{ e.organizer.lastname|first }}
            </div>
          {% endif %}
        </div>
        <div class="flex-1">
          <p class="font-medium">{{ e.organizer.firstname }} {{ e.organizer.lastname }}</p>
          {% if e.organizer.city %}
            <p class="text-sm text-gray-600">{{ e.organizer.city }}</p>
          {% endif %}
          {% if e.organizer.runningLevel %}
            {% set levels = {
              BEGINNER: 'D√©butant',
              INTERMEDIATE: 'Interm√©diaire',
              ADVANCED: 'Avanc√©',
              EXPERT: 'Expert',
            } %}
            <p class="text-sm text-gray-600">Niveau : {{ levels[e.organizer.runningLevel.value] ?? e.organizer.runningLevel.value }}</p>
          {% endif %}
          {% if e.organizer.bio %}
            <p class="text-sm text-gray-700 mt-2">{{ e.organizer.bio }}</p>
          {% endif %}
        </div>
      </div>
    </div>

    {# ========== BLOC STATUT ========== #}
    <div class="bg-white rounded-2xl shadow p-6">
      <h3 class="font-semibold mb-3">Statut de l'√©v√®nement</h3>
      {% set statusLabels = {
        DRAFT: 'Brouillon',
        PUBLISHED: 'Publi√©',
        CANCELLED: 'Annul√©',
        COMPLETED: 'Termin√©',
      } %}
      {% set statusColors = {
        DRAFT: 'bg-gray-100 text-gray-700',
        PUBLISHED: 'bg-green-100 text-green-700',
        CANCELLED: 'bg-red-100 text-red-700',
        COMPLETED: 'bg-blue-100 text-blue-700',
      } %}
      <span class="inline-block px-3 py-1 rounded-full text-sm font-medium {{ statusColors[effectiveStatus.value] ?? 'bg-gray-100 text-gray-700' }}">
        {{ statusLabels[effectiveStatus.value] ?? effectiveStatus.value }}
      </span>
    </div>

    {# ========== BLOC INFOS PRATIQUES ========== #}
    <div class="bg-white rounded-2xl shadow p-6">
      <h3 class="font-semibold mb-3">Infos pratiques</h3>
      <ul class="text-sm text-gray-700 space-y-2 list-disc ml-4">
        <li>Pensez √† vous hydrater avant et apr√®s</li>
        <li>Pr√©voyez une tenue adapt√©e √† la m√©t√©o</li>
        <li>Arrivez 10 minutes avant l'heure de d√©part</li>
        <li>Respectez les autres coureurs et l'environnement</li>
      </ul>
    </div>
  </aside>
</main>
{% endblock %}