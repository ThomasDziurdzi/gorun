{% extends 'base.html.twig' %}
{% block title %}Détail évènement · GoRun{% endblock %}
{% block body %}
{% set confirmedCount = e.registrations|filter(r => r.status.value == 'CONFIRMED')|length %}

{% set confirmedCount = e.registrations|filter(r => r.status == 'CONFIRMED')|length %}
{% set spotsLeft = e.maxParticipants - confirmedCount %}

<section class="relative rounded-2xl overflow-hidden">
  <img src="{{ e.coverImage ?: 'https://images.unsplash.com/photo-1520975922284-9f8a3551c2f0?q=80&w=1200&auto=format&fit=crop' }}" alt="{{ e.title }}" class="h-72 w-full object-cover" />
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="absolute inset-0 flex items-end">
    <div class="max-w-6xl mx-auto px-4 md:px-6 pb-6">
      <h1 class="text-3xl md:text-4xl font-extrabold text-white drop-shadow">{{ e.title }}</h1>
      <p class="text-white/90 mt-2">
        {{ e.eventDate|date('l d F Y à H:i')|capitalize }} • 
        {{ e.location.city }} • 
        {{ e.distance }} km
        {% if e.pace %} • Allure {{ e.pace }}{% endif %}
      </p>
    </div>
  </div>
</section>

<main class="py-8 grid lg:grid-cols-3 gap-8">
  <article class="lg:col-span-2">
    <div class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-xl font-bold mb-4">À propos</h2>
      <p class="text-gray-700 mb-6">{{ e.description ?: "Aucune description disponible." }}</p>

      <div class="grid sm:grid-cols-2 gap-4">
        <div class="p-4 rounded-2xl bg-gray-50">
          <h3 class="font-semibold mb-1">Date et heure</h3>
          <p class="text-gray-700">{{ e.eventDate|date('d/m/Y à H:i') }}</p>
        </div>
        <div class="p-4 rounded-2xl bg-gray-50">
          <h3 class="font-semibold mb-1">Durée estimée</h3>
          <p class="text-gray-700">
            {% if e.estimateDuration %}
              {{ (e.estimateDuration / 60)|round(0, 'floor') }}h{{ e.estimateDuration % 60 }}min
            {% else %}
              Non précisée
            {% endif %}
          </p>
        </div>
        <div class="p-4 rounded-2xl bg-gray-50">
          <h3 class="font-semibold mb-1">Distance</h3>
          <p class="text-gray-700">{{ e.distance }} km</p>
        </div>
        <div class="p-4 rounded-2xl bg-gray-50">
          <h3 class="font-semibold mb-1">Allure prévue</h3>
          <p class="text-gray-700">{{ e.pace ?: "Non précisée" }}</p>
        </div>
        <div class="p-4 rounded-2xl bg-gray-50">
          <h3 class="font-semibold mb-1">Niveau requis</h3>
          <p class="text-gray-700">
            {{ e.requiredLevel.label }}
          </p>
        </div>
        <div class="p-4 rounded-2xl bg-gray-50">
          <h3 class="font-semibold mb-1">Participants</h3>
          <p class="text-gray-700">{{ confirmedCount }} / {{ e.maxParticipants }}</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow p-6 mt-6">
      <h2 class="text-xl font-bold mb-4">Lieu de rendez-vous</h2>
      
      <div class="mb-4">
        <h3 class="font-semibold mb-2">{{ e.location.locationName }}</h3>
        <p class="text-gray-700">
          {{ e.location.address }}<br>
          {{ e.location.postalCode }} {{ e.location.city }}
          {% if e.location.country %}, {{ e.location.country }}{% endif %}
        </p>
        {% if e.location.meetingPoint %}
          <p class="text-sm text-gray-600 mt-2">
            <strong>Point de RDV précis :</strong> {{ e.location.meetingPoint }}
          </p>
        {% endif %}
        {% if e.location.description %}
          <p class="text-sm text-gray-600 mt-2">{{ e.location.description }}</p>
        {% endif %}
      </div>

      <div class="rounded-2xl overflow-hidden border">
        <iframe 
          title="Carte du lieu" 
          src="https://www.openstreetmap.org/export/embed.html?bbox={{ e.location.longitude - 0.01 }}%2C{{ e.location.latitude - 0.01 }}%2C{{ e.location.longitude + 0.01 }}%2C{{ e.location.latitude + 0.01 }}&layer=mapnik&marker={{ e.location.latitude }}%2C{{ e.location.longitude }}" 
          class="w-full h-72"
        ></iframe>
      </div>
      <p class="text-xs text-gray-500 mt-2">
        Coordonnées : {{ e.location.latitude }}, {{ e.location.longitude }}
      </p>
    </div>

    {% if e.comments is not empty %}
    <div class="bg-white rounded-2xl shadow p-6 mt-6">
      <h2 class="text-xl font-bold mb-4">Commentaires ({{ e.comments|length }})</h2>
      <div class="space-y-4">
        {% for comment in e.comments %}
          <div class="border-b pb-4 last:border-b-0">
            <div class="flex items-start gap-3">
              <div class="h-10 w-10 rounded-full bg-green-100 flex items-center justify-center font-bold text-green-700 shrink-0">
                {{ comment.author.firstname|first }}{{ comment.author.lastname|first }}
              </div>
              <div class="flex-1">
                <div class="flex items-center justify-between mb-1">
                  <p class="font-semibold">{{ comment.author.firstname }} {{ comment.author.lastname|first }}.</p>
                  <p class="text-xs text-gray-500">{{ comment.publicationDate|date('d/m/Y à H:i') }}</p>
                </div>
                {% if comment.rating %}
                  <div class="flex items-center gap-1 mb-2">
                    {% for i in 1..5 %}
                      <span class="{% if i <= comment.rating %}text-yellow-500{% else %}text-gray-300{% endif %}">★</span>
                    {% endfor %}
                  </div>
                {% endif %}
                <p class="text-gray-700 text-sm">{{ comment.content }}</p>
                {% if comment.updatedDate %}
                  <p class="text-xs text-gray-400 mt-1">Modifié le {{ comment.updatedDate|date('d/m/Y') }}</p>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </article>

  <aside class="lg:col-span-1 space-y-6">
    <div class="bg-white rounded-2xl shadow p-6">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Inscription</h3>
        {% if spotsLeft > 0 %}
          <span class="text-sm font-medium {{ spotsLeft <= 5 ? 'text-amber-600' : 'text-green-600' }}">
            {{ spotsLeft }} place{{ spotsLeft > 1 ? 's' : '' }} restante{{ spotsLeft > 1 ? 's' : '' }}
          </span>
        {% else %}
          <span class="text-sm font-medium text-red-600">Complet</span>
        {% endif %}
      </div>
      
      {% if spotsLeft > 0 %}
        <a href="{{ path('event_register', {id: e.id}) }}" class="block w-full text-center bg-green-600 text-white py-3 rounded-2xl font-semibold hover:bg-green-700 transition">
          Je m'inscris
        </a>
      {% else %}
        <button disabled class="block w-full text-center bg-gray-400 text-white py-3 rounded-2xl font-semibold cursor-not-allowed">
          Complet
        </button>
      {% endif %}  
    </div>

     {% if is_granted('ROLE_ADMIN') %}
    <div class="bg-amber-50 border border-amber-200 rounded-2xl p-6">
      <h3 class="font-semibold mb-3 text-amber-800"> Administration</h3>
      <div class="space-y-3">
        <a href="{{ path('event_edit', {id: e.id}) }}" 
           class="block w-full text-center bg-blue-600 text-white py-3 rounded-2xl font-semibold hover:bg-blue-700 transition">
           Modifier l'événement
        </a>
        
        <form method="post" action="{{ path('event_delete', {id: e.id}) }}" 
              onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cet événement ? Cette action est irréversible.');">
          <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ e.id) }}">
          <button type="submit" 
                  class="block w-full text-center bg-red-600 text-white py-3 rounded-2xl font-semibold hover:bg-red-700 transition">
             Supprimer l'événement
          </button>
        </form>
      </div>
    </div>
    {% endif %}

    <div class="bg-white rounded-2xl shadow p-6">
      <h3 class="font-semibold mb-3">Organisateur</h3>
      <div class="flex items-start gap-3">
        <div class="h-12 w-12 rounded-full bg-green-100 flex items-center justify-center font-bold text-green-700 shrink-0">
          {{ e.organizer.firstname|first }}{{ e.organizer.lastname|first }}
        </div>
        <div class="flex-1">
          <p class="font-medium">{{ e.organizer.firstname }} {{ e.organizer.lastname }}</p>
          {% if e.organizer.city %}
            <p class="text-sm text-gray-600">{{ e.organizer.city }}</p>
          {% endif %}
          {% if e.organizer.runningLevel %}
            {% set levels = {
              'BEGINNER': 'Débutant',
              'INTERMEDIATE': 'Intermédiaire',
              'ADVANCED': 'Avancé',
              'EXPERT': 'Expert'
            } %}
            <p class="text-sm text-gray-600">Niveau : {{ levels[e.organizer.runningLevel.value] ?? e.organizer.runningLevel.value }}</p>
          {% endif %}
          {% if e.organizer.bio %}
            <p class="text-sm text-gray-700 mt-2">{{ e.organizer.bio }}</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow p-6">
      <h3 class="font-semibold mb-3">Statut de l'évènement</h3>
      {% set statusLabels = {
        'DRAFT': 'Brouillon',
        'PUBLISHED': 'Publié',
        'CANCELLED': 'Annulé',
        'COMPLETED': 'Terminé'
      } %}
      {% set statusColors = {
        'DRAFT': 'bg-gray-100 text-gray-700',
        'PUBLISHED': 'bg-green-100 text-green-700',
        'CANCELLED': 'bg-red-100 text-red-700',
        'COMPLETED': 'bg-blue-100 text-blue-700'
      } %}
      <span class="inline-block px-3 py-1 rounded-full text-sm font-medium {{ statusColors[e.status.value] ?? 'bg-gray-100 text-gray-700' }}">
        {{ statusLabels[e.status.value] ?? e.status.value }}
      </span>
    </div>

    <div class="bg-white rounded-2xl shadow p-6">
      <h3 class="font-semibold mb-3">Infos pratiques</h3>
      <ul class="text-sm text-gray-700 space-y-2 list-disc ml-4">
        <li>Pensez à vous hydrater avant et après</li>
        <li>Prévoyez une tenue adaptée à la météo</li>
        <li>Arrivez 10 minutes avant l'heure de départ</li>
        <li>Respectez les autres coureurs et l'environnement</li>
      </ul>
    </div>
  </aside>
</main>
{% endblock %}